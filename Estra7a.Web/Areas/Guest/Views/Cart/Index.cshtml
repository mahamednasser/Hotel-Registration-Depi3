@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@model Cart
@{
    Layout = "_Layout";
    ViewData["Title"] = "My Cart";
}
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@{
    var user = await UserManager.GetUserAsync(User);
}


<div class="container-fluid my-5">
    <div class="row">
        <aside class="col-lg-9">
            <div class="card">
                <div class="table-responsive">

                    <form method="post">
                        @Html.AntiForgeryToken()
                    </form>

                    <table class="table table-borderless table-shopping-cart">
                        <thead class="text-muted">
                            <tr class="small text-uppercase">
                                <th class="col-2">@Localizer["Rooms"]</th>
                               
                                
                                <th class="col-2" >@Localizer["Price"]</th>
                                <th class="col-2" >@Localizer["Quantity"]</th>
                                <th class="col-2" >@Localizer["Total Price"]</th>
                                <th class="col-2" ></th>
                                <th class="col-2" ></th>
                            </tr>
                        </thead>
                        <tbody>
                           @foreach (var item in Model.CartItems)
{
    <tr>
        <td>
            <figure class="itemside align-items-center">
                <div class="image">
                    <img src="~/RoomImages/@item.RoomImage" class="img-sm" />
                </div>
                <figcaption class="info">
                    <a asp-action="Details" asp-controller="Room" asp-area="Guest" asp-route-id="@item.RoomId" class="title text-dark">
                        @item.RoomName
                    </a>
                    <p class="text-muted small">Area: @item.Area </p>
                </figcaption>
            </figure>
        </td>

        <td>@item.Price</td>

        <td>
            <div class="input-group">
                <div class="input-group-prepend">
                    <button class="btn btn-outline-secondary btn-sm decrease-qty" type="button" data-roomid="@item.RoomId">-</button>
                </div>
                <input type="text"
                       class="form-control text-center quantity-input border-0 shadow-none"
                       value="@item.Quantity"
                       readonly
                       data-roomid="@item.RoomId"
                       data-max="@item.Room.NumberOfAvailableRooms" />

                <div class="input-group-append">
                    <button class="btn btn-outline-secondary btn-sm increase-qty" type="button" data-roomid="@item.RoomId">+</button>
                </div>
            </div>
        </td>

        <td class="total-cell">
            @(item.Price * item.Quantity)
        </td>

        <td class="text-right">
            <button class="btn btn-light btn-sm remove-item" data-roomid="@item.RoomId" type="button">
                @Localizer["Remove"]
            </button>
            

        </td>
        <td>
            <button type="button" class="btn btn-info btn-sm toggle-form" data-roomid="@item.RoomId">
    <i class="bi bi-chevron-down"></i> Book Now
</button>
        </td>
    </tr>

    
   <tr class="form-row-expanded" id="form-@item.RoomId" style="display:none;">

        <td colspan="6">

            <form asp-action="Create" asp-controller="Booking" asp-area="Guest" method="post"
                  class="reservation-form mt-3 p-3 border rounded bg-light" enctype="multipart/form-data">

                <input type="hidden" name="roomId" value="@item.RoomId" />

                <div class="text-danger" asp-validation-summary="All"></div>

                <div class="row g-3">

                    <div class="col-md-6">
                        <label>@Localizer["CheckInDate"]</label>
                         <input type="text" id="checkIn" name="checkIn" class="form-control" required />
                    </div>

                    <div class="col-md-6">
                        <label>@Localizer["CheckOutDate"]</label>
<input type="text" id="checkOut" name="checkOut" class="form-control" required />
</div>

                    <div class="col-md-6">
                        <label>@Localizer["guests"]</label>
                        <select name="guests" class="form-select" required>
                            <option value="">Select Guests</option>
                            <option value="1">1 Guest</option>
                            <option value="2">2 Guests</option>
                            <option value="3">3 Guests</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label>@Localizer["TotalRooms"]</label>
                        <select class="form-select" name="room_count" required>
                            <option value="">Choose Rooms</option>
                            <option value="1">1 Room</option>
                            <option value="2">2 Rooms</option>
                            <option value="3">3 Rooms</option>
                        </select>
                    </div>

                    <h5 class="mt-3">@Localizer["GuestInfo"]</h5>

                    <div class="col-md-12">
                        <label>UserName</label>
                        <input type="text" value="@user?.UserName" readonly class="form-control" />
                    </div>

                    <div class="col-md-12">
                        <label>Phone Number</label>
                        <input type="text" name="phoneNumber" class="form-control" required placeholder="01012345678" />
                    </div>

                    <div class="col-md-12">
                        <label>@Localizer["NationalID"]</label>
                        <input type="file" 
       name="NationalIdImage" 
       class="form-control national-id-input" 
       data-roomid="@item.RoomId" 
       id="NationalIdImage-@item.RoomId"
       required />

<span class="text-danger" id="NationalIdError-@item.RoomId"></span>

                    </div>

                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary w-100">
                        @Localizer["ConfirmBooking"]
                    </button>
                </div>

                <script>
                                                document.getElementById("NationalIdImage").addEventListener("change", function () {
                                                    var fileInput = this;
                                                    var formData = new FormData();
                                                    formData.append("NationalIdImage", fileInput.files[0]);

                                                    fetch('@Url.Action("ValidateNationalId", "Booking", new { area = "Guest" })', {
                                                        method: "POST",
                                                        body: formData
                                                    })
                                                    .then(response => response.json())
                                                    .then(data => {
                                                        var errorSpan = document.getElementById("NationalIdError");
                                                        if (!data.isValid) {
                                                            errorSpan.textContent = data.message;
                                                            fileInput.value = "";
                                                        } else {
                                                            errorSpan.textContent = "";
                                                        }
                                                    })
                                                    .catch(err => console.error(err));
                                                });
                                            </script>
            </form>

        </td>
    </tr>

}
                       </tbody>
                    </table>
                </div>
            </div>
        </aside>

        <aside class="col-lg-3">
            <div class="card">
                <div class="card-body">
                    <dl class="d-flex align-items-center justify-content-between p-3 rounded shadow-sm bg-light" style="max-width: 400px;">
                        <dt class="mb-0 text-secondary" style="font-weight: 600; font-size: 18px;">
                            @Localizer["Total"]:
                        </dt>
                        <dd class="mb-0 text-success total-price" style="font-size: 20px; font-weight: bold;">
                            @Model.CartItems.Sum(i => i.Price * i.Quantity) @Localizer["LE"]
                        </dd>
                    </dl>

                    <hr />
                  
                    <a asp-area="Guest" asp-action="Index" asp-controller="Room" class="btn btn-success btn-main w-100">@Localizer["Continue Shopping"]</a>
                </div>
            </div>
        </aside>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            $(".increase-qty").click(function () {
                var roomId = $(this).data("roomid");
                var input = $(".quantity-input[data-roomid='" + roomId + "']");
                var currentQty = parseInt(input.val());
                var maxQty = parseInt(input.data("max"));
                if (currentQty < maxQty) {
                    var newQty = currentQty + 1;
                    input.val(newQty);
                    updateQuantity(roomId, newQty, input);
                } else {
                    showToast("No more available rooms of this type");
                }
            });

            $(".decrease-qty").click(function () {
                var roomId = $(this).data("roomid");
                var input = $(".quantity-input[data-roomid='" + roomId + "']");
                var currentQty = parseInt(input.val());
                if (currentQty > 1) {
                    var newQty = currentQty - 1;
                    input.val(newQty);
                    updateQuantity(roomId, newQty, input);
                }
            });

            function updateQuantity(roomId, quantity, input) {
                fetch('/Guest/Cart/UpdateQuantity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({
                        RoomId: roomId,
                        Quantity: quantity
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                           var price = parseFloat(input.closest("tr").find("td:nth-child(2)").text());

                            var totalCell = input.closest("tr").find(".total-cell");
                            totalCell.text((price * quantity).toFixed(2));
                            $(".total-price").text("$" + data.totalPrice.toFixed(2));
                        }
                    });
            }

            function showToast(message) {
                var toast = $('<div class="toast-message">' + message + '</div>');
                $("body").append(toast);
                toast.fadeIn(300).delay(2000).fadeOut(400, function () {
                    $(this).remove();
                });
            }

            $("<style>")
                .prop("type", "text/css")
                .html(`
                        .toast-message {
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            background: #333;
                            color: #fff;
                            padding: 10px 15px;
                            border-radius: 8px;
                            z-index: 9999;
                            font-size: 14px;
                            display: none;
                        }
                    `)
                .appendTo("head");
        }); $(".remove-item").click(function (e) {
            e.preventDefault();

            const roomId = $(this).data("roomid");

            fetch('/Guest/Cart/RemoveItem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                body: JSON.stringify(roomId)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {

                        $("button[data-roomid='" + roomId + "']").closest("tr").remove();


                        $(".total-price").text("$" + data.totalPrice.toFixed(2));


                        if ($("tbody tr").length === 0) {
                            window.location.href = '/Guest/Cart/EmptyCart';
                        }
                    }
                });
        });


    </script>
    <script>
        $(document).on("click", ".toggle-form", function () {
    var roomId = $(this).data("roomid");
    var formRow = $("#form-" + roomId);

    formRow.toggle(); // show/hide

    
    if (formRow.is(":visible")) {
        $(this).html('<i class="bi bi-chevron-up"></i> Hide');
    } else {
        $(this).html('<i class="bi bi-chevron-down"></i> Only This');
    }
});

    </script>
    <script>


        $(function () {

            $("#checkIn").datepicker({
                minDate: 0,              // يمنع الأيام قبل النهاردة
                dateFormat: "yy-mm-dd",
                onSelect: function (selectedDate) {
                    $("#checkOut").datepicker("option", "minDate", selectedDate);
                }
            });

            $("#checkOut").datepicker({
                dateFormat: "yy-mm-dd"
            });

        });

    </script>
    <script>
$(document).on("change", ".national-id-input", function () {

    var fileInput = this;
    var roomId = $(this).data("roomid");
    var errorSpan = $("#NationalIdError-" + roomId);

    var formData = new FormData();
    formData.append("NationalIdImage", fileInput.files[0]);

    fetch('@Url.Action("ValidateNationalId", "Booking", new { area = "Guest" })', {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.isValid) {
            errorSpan.text(data.message);
            fileInput.value = "";
        } else {
            errorSpan.text("");
        }
    })
    .catch(err => console.error(err));
});
</script>

    <style>
        
        .table-shopping-cart td:nth-child(4),
        .table-shopping-cart th:nth-child(4) {
            padding-left: 30px;
            width: 150px;
        }

     

    /* خلايا الجدول بشكل متناسق */
    .table-shopping-cart td,
    .table-shopping-cart th {
        vertical-align: middle !important;
        padding: 10px 8px !important; /* تقليل المسافات الداخلية */
    }

    /* عرض العمود الأول (الصورة + الاسم) */
    .table-shopping-cart th:nth-child(1),
    .table-shopping-cart td:nth-child(1) {
        width: 230px;
    }

    /* السعر */
    .table-shopping-cart th:nth-child(2),
    .table-shopping-cart td:nth-child(2) {
        width: 120px;
        text-align: center;
    }

    /* الكمية */
    .table-shopping-cart th:nth-child(3),
    .table-shopping-cart td:nth-child(3) {
        width: 140px;
        text-align: center;
    }

    /* إجمالي السعر */
    .table-shopping-cart th:nth-child(4),
    .table-shopping-cart td:nth-child(4) {
        width: 140px;
        text-align: center;
        font-weight: 600;
    }

    /* زر الحذف */
    .table-shopping-cart th:nth-child(5),
    .table-shopping-cart td:nth-child(5),
    .table-shopping-cart th:nth-child(6),
    .table-shopping-cart td:nth-child(6) {
        width: 110px;
        text-align: center;
    }

    /* الصورة داخل السطر */
    .img-sm {
        width: 90px;
        height: 70px;
        object-fit: cover;
        border-radius: 6px;
    }

    /* الفورم */
    .reservation-form {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-top: 10px;
    }

</style>



    
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

 <!-- jQuery UI -->
 <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
 <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>


 <script src="/assets/js/main.js"></script>

